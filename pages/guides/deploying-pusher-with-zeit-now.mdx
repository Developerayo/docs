import Guide from '~/components/layout/guide'
import Snippet from '~/components/snippet'
import { InlineCode } from '~/components/text/code'
import Caption from '~/components/text/caption'
import Note from '~/components/text/note'
import { Image } from '~/components/media'

export const meta = {
  title: 'Deploying Realtime Serverless Apps with Pusher and ZEIT Now',
  description:
    'How to get started building and deploying realtime serverless apps with Pusher on ZEIT Now.',
  published: '2019-08-20T19:22:52.039Z',
  authors: ['coetry'],
  url: '/guides/deploying-pusher-with-zeit-now',
  image:
    'https://og-image.now.sh/**Deploy%20Serverless%20Pusher%20Apps**%20with%20ZEIT%20Now.png?theme=light&md=1&fontSize=85px&images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fzeit-black-triangle.svg&images=https%3A%2F%2Fpusher-icon.now-examples.now.sh',
  editUrl: 'pages/guides/deploying-pusher-with-zeit-now.mdx',
  lastEdited: '2019-08-25T21:35:37.000Z'
}

[Pusher](https://pusher.com/) is a service that makes it easy to add real-time data and functionality to web and mobile applications.

This guide demonstrates how to get started creating and deploying real-time serverless applications with Pusher, and ZEIT Now.

<Note>
  This guide will not be a full code walkthrough, but rather an overview of the
  key pieces. Please refer to the full source code linked at the bottom of the
  guide to see how everything fits together.
</Note>

## Step 1: Pusher Account Setup

Let's start by making an account on [Pusher](https://dashboard.pusher.com/accounts/sign_up) and creating a new app. Locate the _Create new app_ button on the left sidebar.

<Image
  src={`/static/guides/deploying-pusher-with-now/create-new-pusher-app.png`}
  width={650}
  height={380}
  oversize
/>
<Caption>Creating a new app from the Pusher dashboard.</Caption>

Next, we'll give our app a name and select a region. Choose a region closest to the majority of your customers to minimize latency.

<Image
  src={`/static/guides/deploying-pusher-with-now/name-pusher-app.png`}
  width={650}
  height={380}
  oversize
/>
<Caption>Adding a <InlineCode>name</InlineCode> and <InlineCode>region</InlineCode> to the app from the Pusher dashboard.</Caption>

From your dashboard, you can scroll down to find all of your pusher apps. Locate the one you just created and click on it.

<Image
  src={`/static/guides/deploying-pusher-with-now/click-newly-created-pusher-app.png`}
  width={650}
  height={380}
  oversize
/>
<Caption>Selecting the app from the Pusher dashboard.</Caption>

Finally, click on the tab that reveals your App Keys. We need to copy these values so that we can save them as secrets and then pass them as environment variables.

<Image
  src={`/static/guides/deploying-pusher-with-now/pusher-app-keys.png`}
  width={650}
  height={380}
  oversize
/>
<Caption>Viewing the <InlineCode>App Keys</InlineCode> from the Pusher dashboard.</Caption>

## Step 2: Set Up Your Project

Now that we have our Pusher account and app set up, let's create our directory structure. All we need is a root directory where our static files will live, and an `/api` directory with our lambda functions.

<Snippet dark text="mkdir -p realtime-lambda/api && cd realtime-lambda" />

With our directory set up, create an `index.html` file with the following code:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <script src="https://js.pusher.com/4.4/pusher.min.js"></script>
    <script src="main.js"></script>
  </body>
</html>
```

<Caption>
  Adding <InlineCode>script</InlineCode> tags inside the{' '}
  <InlineCode>body</InlineCode>of our <InlineCode>index.html</InlineCode> file.
</Caption>

We want to create an instance of a Pusher client that subscribes and reacts to events on the appropriate channel. We also want to send data to our lambda that will trigger a push event.

Create a `main.js` file where we'll initialize a Pusher object with our app key, subscribe to the appropriate channel and bind a callback function to react to our events within that channel.

```js
// initialize Pusher client
let pusher = new Pusher('app-key', {
  cluster: 'cluster-region'
})

// subscribe to the appropriate channel channel
let channel = pusher.subscribe('channel-name')

// bind a callback function to an event within the channel
channel.bind('event-name', function(data) {
  // do stuff with data
})
```

<Caption>
  Initializing a <InlineCode>Pusher</InlineCode> client, subscribing to a
  channel, and binding to an event.
</Caption>

All that's remaining on the client is to create a way to send data to our backend to trigger push events. Add the snippet below to your <InlineCode>main.js</InlineCode> file to achieve this.

```js
async function pushData(data) {
  const res = await fetch('/api/pusher-lambda', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  if (!res.ok) {
    console.error('failed to push data')
  }
}
```

<Caption>
  A function in <InlineCode>main.js</InlineCode> to send event data to our{' '}
  <InlineCode>/api</InlineCode> endpoint.
</Caption>

Using [Now CLI](/download), add the following [Now Secrets](https://zeit.co/docs/v2/build-step#using-environment-variables-and-secrets) to your account and expose them as environment variables.

<Snippet dark text={`now secrets add pusher-app-id my-pusher-app-id`} />
<Caption>
  Adding the <InlineCode>pusher-app-id</InlineCode> as a Now Secret.
</Caption>

<Snippet dark text={`now secrets add pusher-app-secret my-pusher-app-secret`} />
<Caption>
  Adding the <InlineCode>pusher-app-secret</InlineCode> as a Now Secret.
</Caption>

<Note hint>
  {' '}
  Since the app key and cluster are already exposed on the client and they are not
  sensitive, we <b>do not need</b> to add them as secrets.
</Note>

Next, create a minimal <InlineCode>now.json</InlineCode> file with environment variables to expose the secrets you added to your account, replacing `app-key` and `cluster-region` with the plaintext provided by Pusher.

```json
{
  "version": 2,
  "env": {
    "APP_ID": "@pusher-app-id",
    "KEY": "app-key",
    "SECRET": "@pusher-ap-secret",
    "CLUSTER": "cluster-region"
  }
}
```

<Caption>
  An example <InlineCode>now.json</InlineCode> file that provides the app with
  environment variables.
</Caption>

Add the dependencies for the Serverless Function from inside the <InlineCode>/api</InlineCode> directory.

<Snippet dark text="cd api && npm i pusher" />
<Caption>Entering the <InlineCode>/api</InlineCode> directory and installing the <InlineCode>pusher</InlineCode> npm package</Caption>

Create a `pusher-lambda.js` inside the `/api` directory that initializes a new Pusher object and receives data from the [`req.body` helper method](https://zeit.co/docs/v2/serverless-functions/supported-languages/#node.js-request-and-response-objects), before invoking [`pusher.trigger`](https://github.com/pusher/pusher-http-node#publishing-events) to register the event.

```js
const Pusher = require('pusher')

const {
  APP_ID: appId,
  KEY: key,
  SECRET: secret,
  CLUSTER: cluster
} = process.env

const pusher = new Pusher({
  appId,
  key,
  secret,
  cluster
})

module.exports = (req, res) => {
  const data = req.body
  pusher.trigger('event-channel', 'event-name', data)
  res.status(200).end('sent event succesfully')
}
```

<Caption>
  An example <InlineCode>pusher-lambda.js</InlineCode> file inside the{' '}
  <InlineCode>/api</InlineCode> directory
</Caption>

When `pusher.trigger` is called, an event will be broadcasted to all subscribed clients.

## Step 3: Deplying with ZEIT Now

With your Pusher app set up, it is ready to be [deployed](/docs/v2/deployments/basics/) with [ZEIT Now](/docs/v2).

If you have not yet installed Now, you can do so by installing [Now CLI](/download).

You are now ready to deploy your app with **just a single command**:

<Snippet dark text="now" />
<Caption>Deploying your project with just a single command.</Caption>

If you want to deploy your Pusher project when you push to a Git repository, you can use either [Now for GitHub](/docs/v2/integrations/now-for-github/) or [Now for GitLab](/docs/v2/integrations/now-for-gitlab/) to have your project automatically deployed on every push, and aliased on push to master.

We've created a more complete demo with these concepts [here](https://github.com/zeit/now-examples/pull/468). Take a look, hack around, and give us your feedback.

export default ({ children }) => <Guide meta={meta}>{children}</Guide>

export const config = {
  amp: 'hybrid'
}
